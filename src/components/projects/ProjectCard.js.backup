import React, { useState, useEffect } from 'react';
import './Projects.css';
import {
  getCategoryProgress,
  updateCategoryProgress,
  initializeProjectProgress,
  getDocumentation,
  getAiPrompts
} from '../../utils/localStorage';

function ProjectCard({ project, isExpanded, onToggle }) {
  const [expandedCategory, setExpandedCategory] = useState(null);
  const [categoryProgress, setCategoryProgress] = useState({});
  const [showProgressInput, setShowProgressInput] = useState(null);
  const [progressValue, setProgressValue] = useState('');
  const [documentation, setDocumentation] = useState({});
  const [aiPrompts, setAiPrompts] = useState({});

  // Function to get project-specific data
  const getProjectDetails = (projectId) => {
    const projectsData = {
      'bayt-elite': {
        categories: [
          {
            id: 'trust-transparency',
            title: 'Trust & Transparency Engine',
            description: 'Building confidence through financial clarity and regulatory compliance',
            features: [
              'Dynamic Payment Calculator: Slider-based with real-time visual payment timeline',
              'Complete Financial Breakdown: Shows construction milestones, service fees, VAT, registration costs',
              'Hijri/Gregorian Dual Timeline: All construction phases in both calendars',
              'Regulatory Compliance Badges: Visual indicators for RERA approval, escrow status',
              '"No Hidden Fees" Guarantee Display'
            ],
            phase: 'Phase 1',
            priority: 'High'
          },
          {
            id: 'cultural-intelligence',
            title: 'Cultural Intelligence System',
            description: 'Understanding and respecting Gulf lifestyle and religious practices',
            features: [
              'Integrated Prayer Times & Qibla: Using Aladhan API with property-specific direction',
              '"View from Prayer Room" Feature: One-click orientation to Qibla with balcony vista',
              'Ramadan/Eid Ready: Special viewing modes and financing options for Islamic months',
              'Family-Centric Layout Highlights: Emphasis on private family areas, maid\'s room, guest reception flow'
            ],
            phase: 'Phase 1',
            priority: 'High'
          },
          {
            id: 'immersive-experience',
            title: 'Immersive Experience Suite',
            description: 'Virtual property experience for remote buyers',
            features: [
              '360° Virtual Tour: Interactive walkthrough with hotspot explanations',
              'Sun Path & Shade Simulation: Visualizes sunlight through property at different times',
              'Seasonal View Preview: Shows property during "green season" vs. summer',
              'VR-Ready Mode: Google Cardboard compatible for premium experience',
              'Neighborhood Context Map: Highlights nearby mosques, schools, clinics'
            ],
            phase: 'Phase 2',
            priority: 'Medium'
          },
          {
            id: 'sales-acceleration',
            title: 'Sales Acceleration Tools',
            description: 'Features that directly help close deals',
            features: [
              'One-Click WhatsApp Connect: Pre-filled messages for agents/developers',
              'Shareable PDF Generator: Customized payment plan + property snapshots',
              '"Save & Compare" Dashboard: For buyers evaluating multiple units',
              'Mortgage Calculator Integration: Pre-approved bank rates from UAE/Saudi lenders',
              'Virtual Consultation Scheduler: Integrated with agent calendars'
            ],
            phase: 'Phase 2',
            priority: 'High'
          },
          {
            id: 'developer-backend',
            title: 'Developer/Agent Backend (MVP)',
            description: 'Analytics and management tools for business users',
            features: [
              'Lead Intelligence Dashboard: Tracks user interactions with properties',
              'PDF Download Analytics: Which plans are shared most frequently',
              '"Hot Lead" Notifications: When users spend >5 mins on calculator or tour',
              'Comparative Analytics: Shows which features drive most engagement'
            ],
            phase: 'Phase 3',
            priority: 'Medium'
          },
          {
            id: 'market-enhancements',
            title: 'Market-Specific Enhancements',
            description: 'Gulf market specific features and compliance',
            features: [
              '"Golden Visa" Eligibility Checker: For UAE properties',
              'Tawtheeq/Rental Yield Calculator: For investment properties',
              'Power/Water Consumption Estimates: Based on property size',
              '"Summer Ready" Features: Highlights chiller systems, pool cooling'
            ],
            phase: 'Phase 3',
            priority: 'Low'
          }
        ]
      },
      'tawasul-ai': {
        categories: [
          {
            id: 'core-features',
            title: 'Core AI Features',
            description: 'Basic AI functionality and translation',
            features: ['Details coming soon...'],
            phase: 'Phase 1',
            priority: 'High'
          }
        ]
      },
      'zimam-delivery': {
        categories: [
          {
            id: 'core-features',
            title: 'Delivery System Features',
            description: 'Core delivery and logistics features',
            features: ['Details coming soon...'],
            phase: 'Phase 1',
            priority: 'High'
          }
        ]
      },
      'almultaqia': {
        categories: [
          {
            id: 'core-features',
            title: 'Dashboard Features',
            description: 'Business intelligence and analytics',
            features: ['Details coming soon...'],
            phase: 'Phase 1',
            priority: 'High'
          }
        ]
      }
    };
    
    return projectsData[projectId] || { categories: [] };
  };

  const projectDetails = getProjectDetails(project.id);
  const totalFeatures = projectDetails.categories.reduce((sum, cat) => sum + cat.features.length, 0);

  // Initialize localStorage data when component mounts
  useEffect(() => {
    if (isExpanded) {
      initializeProjectProgress(project.id, projectDetails.categories);
      
      // Load progress for each category
      const progressData = {};
      projectDetails.categories.forEach(category => {
        progressData[category.id] = getCategoryProgress(project.id, category.id);
      });
      setCategoryProgress(progressData);
      
      // Load documentation and AI prompts
      const docsData = {};
      const promptsData = {};
      projectDetails.categories.forEach(category => {
        docsData[category.id] = getDocumentation(project.id, category.id);
        promptsData[category.id] = getAiPrompts(project.id, category.id);
      });
      setDocumentation(docsData);
      setAiPrompts(promptsData);
    }
  }, [isExpanded, project.id, projectDetails.categories]);

  const toggleCategory = (categoryId) => {
    setExpandedCategory(expandedCategory === categoryId ? null : categoryId);
  };

  const handleProgressUpdate = (categoryId) => {
    const value = parseInt(progressValue);
    if (!isNaN(value) && value >= 0 && value <= 100) {
      updateCategoryProgress(project.id, categoryId, value);
      setCategoryProgress(prev => ({
        ...prev,
        [categoryId]: value
      }));
      setShowProgressInput(null);
      setProgressValue('');
      
      // Force project progress refresh
      setTimeout(() => {
        onToggle(project.id); // Close and reopen to refresh
        setTimeout(() => onToggle(project.id), 100);
      }, 300);
    }
  };

  const handleProgressClick = (categoryId, currentProgress) => {
    setShowProgressInput(categoryId);
    setProgressValue(currentProgress.toString());
  };

  const getDocumentationCount = (categoryId) => {
    return documentation[categoryId]?.length || 0;
  };

  const getAiPromptsCount = (categoryId) => {
    return aiPrompts[categoryId]?.length || 0;
  };

  return (
    <div className={`project-card ${isExpanded ? 'expanded' : ''}`}>
      <div className="project-summary" onClick={() => onToggle(project.id)}>
        <div className="project-header">
          <div className="project-title-section">
            <h3>{project.name}</h3>
            <span className="project-status" style={{ backgroundColor: project.color }}>
              {project.status}
            </span>
          </div>
          <div className="project-progress">
            <div className="progress-bar">
              <div 
                className="progress-fill" 
                style={{ width: `${project.progress}%`, backgroundColor: project.color }}
              ></div>
            </div>
            <span className="progress-text">{project.progress}%</span>
          </div>
          <button className="toggle-btn">
            {isExpanded ? '−' : '+'}
          </button>
        </div>
        
        {!isExpanded && (
          <p className="project-description">{project.description}</p>
        )}
      </div>

      {isExpanded && (
        <div className="project-details">
          <div className="project-overview">
            <h4>Project Overview</h4>
            <p>{project.description}</p>
            <div className="project-meta">
              <span className="meta-item">
                <strong>Target Market:</strong> {project.market}
              </span>
              <span className="meta-item">
                <strong>Priority:</strong> {project.priority}
              </span>
              <span className="meta-item">
                <strong>Total Features:</strong> {totalFeatures}
              </span>
              <span className="meta-item">
                <strong>Categories:</strong> {projectDetails.categories.length}
              </span>
            </div>
          </div>

          <div className="feature-categories">
            <h4>Feature Categories</h4>
            <p className="category-instruction">
              Click on progress bars to update your completion percentage
            </p>
            {projectDetails.categories.map((category) => (
              <div key={category.id} className="category-card">
                <div 
                  className="category-header"
                  onClick={() => toggleCategory(category.id)}
                >
                  <div className="category-title">
                    <h5>{category.title}</h5>
                    <div className="category-meta">
                      <span className="phase-badge">{category.phase}</span>
                      <span className="priority-badge" style={{ 
                        backgroundColor: category.priority === 'High' ? '#ef4444' : 
                                       category.priority === 'Medium' ? '#f59e0b' : '#10b981' 
                      }}>
                        {category.priority}
                      </span>
                      <span className="feature-count">{category.features.length} features</span>
                    </div>
                    <p className="category-description">{category.description}</p>
                  </div>
                  <div className="category-progress">
                    {showProgressInput === category.id ? (
                      <div className="progress-input-container">
                        <input
                          type="number"
                          min="0"
                          max="100"
                          value={progressValue}
                          onChange={(e) => setProgressValue(e.target.value)}
                          className="progress-input"
                          placeholder="0-100"
                          onClick={(e) => e.stopPropagation()}
                        />
                        <button 
                          className="progress-save-btn"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleProgressUpdate(category.id);
                          }}
                        >
                          Save
                        </button>
                      </div>
                    ) : (
                      <div 
                        className="progress-clickable"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleProgressClick(category.id, categoryProgress[category.id] || 0);
                        }}
                      >
                        <div className="progress-bar small">
                          <div 
                            className="progress-fill" 
                            style={{ 
                              width: `${categoryProgress[category.id] || 0}%`, 
                              backgroundColor: project.color 
                            }}
                          ></div>
                        </div>
                        <span className="progress-text">
                          {categoryProgress[category.id] || 0}%
                        </span>
                      </div>
                    )}
                  </div>
                  <button className="category-toggle">
                    {expandedCategory === category.id ? '−' : '+'}
                  </button>
                </div>
                
                {expandedCategory === category.id && (
                  <div className="category-details">
                    <div className="category-features">
                      <h6>Features:</h6>
                      <ul>
                        {category.features.map((feature, index) => (
                          <li key={index}>{feature}</li>
                        ))}
                      </ul>
                    </div>
                    
                    <div className="category-stats">
                      <div className="stat-badge">
                        <span className="stat-label">Documentation:</span>
                        <span className="stat-value">{getDocumentationCount(category.id)} notes</span>
                      </div>
                      <div className="stat-badge">
                        <span className="stat-label">AI Prompts:</span>
                        <span className="stat-value">{getAiPromptsCount(category.id)} saved</span>
                      </div>
                    </div>
                    
                    <div className="category-actions">
                      <button className="action-btn small">Add Note</button>
                      <button className="action-btn small">Add AI Prompt</button>
                      <button className="action-btn small">Add Milestone</button>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>

          <div className="project-instructions">
            <h5>How to use this tracker:</h5>
            <ol>
              <li><strong>Update Progress:</strong> Click on any progress bar to update completion percentage</li>
              <li><strong>Save Data:</strong> All progress is automatically saved to localStorage</li>
              <li><strong>Expand Categories:</strong> Click category headers to see detailed features</li>
              <li><strong>Add Notes:</strong> Use "Add Note" to document your learnings and decisions</li>
            </ol>
          </div>
        </div>
      )}
    </div>
  );
}

export default ProjectCard;
